name: Build and Deploy to AltStore

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get version from Xcode project
        id: version
        run: |
          # Extract version from project.pbxproj
          VERSION=$(grep -m 1 'MARKETING_VERSION' native/RDVHome/RDVHome.xcodeproj/project.pbxproj | sed 's/.*MARKETING_VERSION = \(.*\);/\1/' | tr -d ' ')
          BUILD_NUMBER=$(grep -m 1 'CURRENT_PROJECT_VERSION' native/RDVHome/RDVHome.xcodeproj/project.pbxproj | sed 's/.*CURRENT_PROJECT_VERSION = \(.*\);/\1/' | tr -d ' ')

          echo "📦 Version: $VERSION"
          echo "🔢 Build Number: $BUILD_NUMBER"

          # Create tag with version
          TAG="v${VERSION}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$TAG" -m "Release $TAG" || true
          git push origin "$TAG" || true

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Build IPA version ${{ steps.version.outputs.version }}
        run: |
          cd native/RDVHome

          echo "🔨 Building IPA for version ${{ steps.version.outputs.version }}..."

          # Build for device
          xcodebuild -project RDVHome.xcodeproj \
            -scheme RDVHome \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "$PWD/build/RDVHome.xcarchive" \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

          # Create dist directory in repo root
          cd ../..
          mkdir -p dist

          # Export IPA
          cd native/RDVHome
          mkdir -p build/Payload
          cp -r build/RDVHome.xcarchive/Products/Applications/RDVHome.app build/Payload/
          cd build
          zip -r RDVHome.ipa Payload

          # Move IPA to dist directory
          mv RDVHome.ipa ../../../dist/RDVHome.ipa

          echo "✅ IPA built successfully"

      - name: Generate AltStore source JSON
        run: |
          IPA_SIZE=$(stat -f%z dist/RDVHome.ipa)
          CURRENT_DATE=$(date -u +%Y-%m-%d)

          echo "📝 Generating AltStore JSON for version ${{ steps.version.outputs.version }} (${IPA_SIZE} bytes)"

          cat > dist/apps.json << EOF
          {
            "name": "RDVHome",
            "identifier": "com.rdv.altstore",
            "sourceURL": "https://raw.githubusercontent.com/${{ github.repository }}/master/dist/apps.json",
            "apps": [
              {
                "name": "RDVHome",
                "bundleIdentifier": "com.rdv.RDVHome",
                "developerName": "RDV",
                "subtitle": "Home Automation Controller",
                "localizedDescription": "Control your home automation devices from your iOS device.",
                "iconURL": "https://raw.githubusercontent.com/${{ github.repository }}/master/dist/icon.png",
                "tintColor": "#007AFF",
                "category": "utilities",
                "versions": [
                  {
                    "version": "${{ steps.version.outputs.version }}",
                    "date": "${CURRENT_DATE}",
                    "downloadURL": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/RDVHome.ipa",
                    "localizedDescription": "Latest version of RDVHome",
                    "size": ${IPA_SIZE},
                    "minOSVersion": "15.0"
                  }
                ],
                "appPermissions": {
                  "entitlements": [
                    {
                      "name": "network-client"
                    }
                  ],
                  "privacy": [
                    {
                      "name": "LocalNetwork",
                      "usageDescription": "RDVHome needs access to your local network to communicate with home automation devices."
                    }
                  ]
                }
              }
            ],
            "news": []
          }
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: |
            dist/RDVHome.ipa
            dist/apps.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: RDVHome-${{ steps.version.outputs.version }}
          path: |
            dist/RDVHome.ipa
            dist/apps.json
          retention-days: 90

      - name: Commit and push apps.json to master
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add dist/apps.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Update AltStore apps.json [skip ci]"
          git push origin HEAD:master || git push origin HEAD:main
