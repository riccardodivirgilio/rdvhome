<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RdvHome</title>
    <!-- Bootstrap core CSS -->
    <style>
      *, *:before, *:after {
        box-sizing: border-box;
        font-family: Helvetica Neue,Helvetica,Arial,sans-serif; 
      }
      .container {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
        align-items: center;
      }
      .panel {
          min-width:400px;
      }
      .list-container {
        display: flex;
        flex-direction: column;
        border: 1px solid #ddd;
        border-top: none

      }
      .list-item {
        background:white;
        padding:15px;
        border-top:1px solid #ddd;
        color:black;
      }
      .list-item.on {
        border-right:4px solid lime;
      }
      .list-item.off {
        border-right:4px solid #ddd;
      }
      a.list-item:hover {
        background:#efefef;
      }
      h1, p {
        padding: 0 15px;
      }
      a {
        text-decoration: none;
        color:red;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script type="text/template" id="actions-template">
      <div class="list-container">
        <% _.each(toggles, function(toggle, i) { %> 
            <a class="list-item <%= toggle.status ? 'on' : 'off' %>" style="order:<%= toggle.sequence %>;" onclick="return window.onclicklink('/switch/<%= i %>/toggle')" href="#<%= i %>">
              <%= toggle.name %>
            </a>
        <% }); %>
      </div>
    </script>
    <script type="text/javascript">
      var compiled = _.template(document.getElementById('actions-template').innerText);
      // Create a client instance
      var client = new Paho.MQTT.Client("m21.cloudmqtt.com", 36494, "web_" + parseInt(Math.random() * 100, 10));
      var stack = {};

      // set callback handlers
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;
      var options = {
        useSSL: true,
        userName: "owflekio",
        password: "0aeZc50ixVbT",
        onSuccess:onConnect,
        onFailure:doFail
      }

      // connect the client
      client.connect(options);

      // called when the client connects
      function onConnect() {
        // Once a connection has been made, make a subscription and send a message.
        console.log("onConnect");
        client.subscribe("status");
        var message = new Paho.MQTT.Message("/switch");
        message.destinationName = "command";
        client.send(message); 
      }

      function doFail(e){
        console.log(e);
      }

      // called when the client loses its connection
      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("onConnectionLost:"+responseObject.errorMessage);
        }
      }

      // called when a message arrives
      function onMessageArrived(message) {
        var data = JSON.parse(message.payloadString);
        stack = _.extend(stack, data.toggles);
        document.getElementById('toggles').innerHTML = compiled({toggles: stack});
      }      

      window.onclicklink = function(action) {
        var message = new Paho.MQTT.Message(action);
        message.destinationName = "command";
        client.send(message); 
        return false
      }
    </script>
  </head>
  <body>
    <div class="container">
      <div class="panel">
        <h1>RdV</h1>
        <p class="lead">Controller for GPIO. <a href="{% url 'status' %}" class="small">API &rarr;</a></p>
        <div id="toggles"></div>
      </div>
    </div><!-- /.container -->
  </body>
</html>